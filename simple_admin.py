#!/usr/bin/env python3
"""
–ü—Ä–æ—Å—Ç–∞—è –≤–µ–±-–∞–¥–º–∏–Ω–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞—è–≤–æ–∫
"""

import os
from datetime import datetime
import json

try:
    from flask import Flask, request, jsonify
    from database_service import DatabaseService
except ImportError as e:
    print(f"–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
    print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: pip install flask sqlalchemy psycopg2-binary")
    exit(1)

app = Flask(__name__)

@app.route('/')
def home():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –ø—Ä–æ—Å—Ç—ã–º HTML"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∑–∞—è–≤–∫–∏
        applications = DatabaseService.get_recent_applications(limit=20)
        total = DatabaseService.get_applications_count()
        
        # –ü—Ä–æ—Å—Ç–æ–π HTML
        html = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å AI-—Ä–µ—à–µ–Ω–∏—è</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                body {{ 
                    font-family: Arial, sans-serif; 
                    margin: 20px; 
                    background: #f5f5f5;
                }}
                .header {{ 
                    background: #007bff; 
                    color: white; 
                    padding: 20px; 
                    text-align: center; 
                    border-radius: 8px;
                    margin-bottom: 20px;
                }}
                .stats {{ 
                    background: #f8f9fa; 
                    padding: 15px; 
                    margin: 10px 0; 
                    border-radius: 8px;
                    border-left: 4px solid #007bff;
                }}
                .application {{ 
                    border: 1px solid #ddd; 
                    margin: 10px 0; 
                    padding: 15px; 
                    background: white;
                    border-radius: 8px;
                }}
                .app-id {{ 
                    background: #28a745; 
                    color: white; 
                    padding: 5px 10px; 
                    border-radius: 3px; 
                    display: inline-block;
                    margin-bottom: 10px;
                }}
                .refresh {{ 
                    background: #007bff; 
                    color: white; 
                    padding: 10px 20px; 
                    border: none; 
                    border-radius: 5px;
                    cursor: pointer;
                    margin: 10px 0; 
                }}
                .refresh:hover {{
                    background: #0056b3;
                }}
                .detail-grid {{
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 10px;
                    margin-top: 10px;
                }}
                .detail-item {{
                    background: #f8f9fa;
                    padding: 8px;
                    border-radius: 4px;
                    border-left: 3px solid #007bff;
                }}
                .detail-label {{
                    font-weight: bold;
                    color: #495057;
                    display: block;
                    margin-bottom: 4px;
                }}
                .no-applications {{
                    text-align: center;
                    padding: 40px;
                    color: #666;
                    background: white;
                    border-radius: 8px;
                }}
                @media (max-width: 768px) {{
                    .detail-grid {{
                        grid-template-columns: 1fr;
                    }}
                    body {{
                        margin: 10px;
                    }}
                }}
            </style>
            <script>
                function refreshPage() {{ 
                    location.reload(); 
                }}
                // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
                setTimeout(function(){{ location.reload(); }}, 60000);
            </script>
        </head>
        <body>
            <div class="header">
                <h1>ü§ñ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å AI-—Ä–µ—à–µ–Ω–∏—è</h1>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</p>
            </div>
            
            <button onclick="refreshPage()" class="refresh">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            
            <div class="stats">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <p><strong>–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫:</strong> {total}</p>
                <p><strong>–í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</strong> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}</p>
            </div>
            
            <h3>üìã –ó–∞—è–≤–∫–∏</h3>
        """
        
        if applications:
            for app in applications:
                package_name = {
                    'basic': '–ë–∞–∑–æ–≤—ã–π',
                    'advanced': '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π', 
                    'premium': '–ü—Ä–µ–º–∏—É–º'
                }.get(app.package_interest, app.package_interest or '–Ω–µ —É–∫–∞–∑–∞–Ω')
                
                html += f"""
                <div class="application">
                    <div class="app-id">–ó–∞—è–≤–∫–∞ #{app.id}</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">üë§ –ò–º—è:</span>
                            {app.name}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">üìû –¢–µ–ª–µ—Ñ–æ–Ω:</span>
                            <a href="tel:{app.phone}">{app.phone}</a>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">üì¶ –ü–∞–∫–µ—Ç:</span>
                            {package_name}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">üÜî Telegram ID:</span>
                            {app.user_id}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">‚è∞ –í—Ä–µ–º—è:</span>
                            {app.created_at.strftime('%d.%m.%Y %H:%M')}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">üìä –°—Ç–∞—Ç—É—Å:</span>
                            {app.status or '–Ω–æ–≤–∞—è'}
                        </div>
                    </div>
                </div>
                """
        else:
            html += """
            <div class="no-applications">
                <h3>üì≠ –ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                <p>–ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç—É–ø–∏—Ç –ø–µ—Ä–≤–∞—è –∑–∞—è–≤–∫–∞, –æ–Ω–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</p>
            </div>
            """
        
        html += """
            <div style="text-align: center; margin-top: 40px; padding: 20px; background: white; border-radius: 8px; color: #666;">
                <p>üîÑ <strong>–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É</strong></p>
                <p>üöÄ <a href="https://t.me/echo1995_bot" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ –≤ Telegram</a></p>
            </div>
        </body>
        </html>
        """
        
        return html
        
    except Exception as e:
        return f"<h1>‚ùå –û—à–∏–±–∫–∞</h1><p>{str(e)}</p>"

@app.route('/api/applications')
def api_applications():
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –≤ JSON"""
    try:
        applications = DatabaseService.get_recent_applications(limit=10)
        result = []
        
        for app in applications:
            result.append({
                'id': app.id,
                'name': app.name,
                'phone': app.phone,
                'package_interest': app.package_interest,
                'user_id': app.user_id,
                'created_at': app.created_at.isoformat(),
                'status': app.status
            })
        
        return jsonify({
            'total': DatabaseService.get_applications_count(),
            'applications': result
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/health')
def health():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏"""
    return jsonify({'status': 'ok', 'time': datetime.now().isoformat()})

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=False)
